{% extends 'base.html' %}

{% block content %}
<div class="flex flex-between" style="margin-bottom: 1rem;">
    {% if user.is_authenticated %}
    <button class="btn btn-text" style="color: var(--danger); margin-left: auto;"
        hx-post="{% url 'delete_equipment' equipment.pk %}"
        hx-confirm="Are you sure you want to delete this equipment? This will also delete all associated tasks and updates.">
        Delete Equipment
    </button>
    {% endif %}
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Main Info -->
    <div>
        <div class="card">
            <div class="flex flex-between">
                <h1 style="margin: 0;">{{ equipment.name }}</h1>
                <span class="status-badge status-{{ equipment.status }}">{{ equipment.get_status_display }}</span>
            </div>
            <p class="text-secondary">
                {{ equipment.location }} • Purchased: {{ equipment.purchase_date|default:"Unknown" }}</p>

            {% if equipment.image %}
            <img src="{{ equipment.image.url }}" alt="{{ equipment.name }}"
                style="max-width: 100%; border-radius: 8px; margin: 1rem 0;">
            {% endif %}

            <div style="margin-top: 1rem;">
                <h3>Description</h3>
                <p>{{ equipment.description|linebreaks }}</p>
            </div>
        </div>

        <!-- Updates Log -->
        <div class="card">
            <h3>Updates & Notes</h3>
            <form hx-post="{% url 'add_update' equipment.pk %}" hx-target="#update-list" hx-swap="innerHTML"
                hx-on::after-request="this.reset()">
                {% csrf_token %}
                {{ update_form.content }}
                <button type="submit" class="btn btn-small">Log Update</button>
            </form>
            <div id="update-list" style="margin-top: 1.5rem;">
                {% include 'equipment/partials/update_list.html' %}
            </div>
        </div>
    </div>

    <!-- Sidebar: Tasks -->
    <div>
        <div class="card">
            <h3>Tasks</h3>
            <div id="task-list">
                {% include 'equipment/partials/task_list.html' %}
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 1.5rem 0;">

            {% if user.is_authenticated %}
            <div id="add-task-toggle" style="cursor: pointer; display: flex; align-items: center; gap: 0.5em; user-select: none;" onclick="const f=document.getElementById('add-task-form');const a=document.getElementById('add-task-arrow');if(f.style.display==='none'){f.style.display='block';a.textContent='▼';}else{f.style.display='none';a.textContent='►';}">
                <span id="add-task-arrow">►</span>
                <h4 style="margin: 0; display: inline;">Add Task</h4>
            </div>
            <form id="add-task-form" style="display: none; margin-top: 1em;" hx-post="{% url 'add_task' equipment.pk %}" hx-target="#task-list" hx-swap="innerHTML" hx-on::after-request="this.reset()">
                {% csrf_token %}
                {{ task_form.as_p }}
                <button type="submit" class="btn btn-small" style="width: 100%;">Add Task</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}